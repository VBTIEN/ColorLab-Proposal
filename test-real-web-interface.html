<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorLab Test - Real Web Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        #results { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .color-box { display: inline-block; width: 30px; height: 30px; margin: 5px; border: 1px solid #000; }
    </style>
</head>
<body>
    <h1>üé® ColorLab Real Web Interface Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p><strong>API URL:</strong> <span id="apiUrl"></span></p>
        <p><strong>Test Image:</strong> image_test.jpg (simulated)</p>
        <p><strong>Status:</strong> <span id="testStatus">Ready</span></p>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runTest()" id="testBtn">Run ColorLab Test</button>
        <button onclick="clearResults()" id="clearBtn">Clear Results</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>Color Display Test</h2>
        <div id="colorDisplay"></div>
    </div>

    <script>
        // Configuration (same as ColorLab)
        const API_BASE_URL = 'https://spsvd9ec7i.execute-api.ap-southeast-1.amazonaws.com/prod';
        
        // Enhanced RGB handling function (copied from ColorLab)
        function normalizeRgbData(rgbData) {
            if (!rgbData) return [128, 128, 128];
            if (Array.isArray(rgbData)) return rgbData;
            if (typeof rgbData === 'object' && rgbData.r !== undefined) {
                return [rgbData.r, rgbData.g, rgbData.b];
            }
            return [128, 128, 128];
        }

        // Enhanced color processing function (copied from ColorLab)
        function processColorData(color) {
            return {
                ...color,
                rgb: normalizeRgbData(color.rgb),
                hex: color.hex || '#808080',
                percentage: color.percentage || 0,
                name: color.name || 'Unknown'
            };
        }

        // Initialize
        document.getElementById('apiUrl').textContent = API_BASE_URL;

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('colorDisplay').innerHTML = '';
        }

        async function runTest() {
            const testBtn = document.getElementById('testBtn');
            const testStatus = document.getElementById('testStatus');
            
            testBtn.disabled = true;
            testStatus.textContent = 'Running...';
            
            try {
                log('üé® Starting ColorLab Real Web Interface Test', 'info');
                
                // Step 1: Test API Health
                log('1. Testing API Health...', 'info');
                const healthResponse = await fetch(`${API_BASE_URL}/health`);
                const healthData = await healthResponse.json();
                
                if (healthData.success) {
                    log(`‚úÖ API Health OK - Version: ${healthData.version}`, 'success');
                } else {
                    log('‚ùå API Health Failed', 'error');
                    return;
                }

                // Step 2: Simulate image upload (using small test image)
                log('2. Simulating image upload...', 'info');
                const testImageBase64 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
                const requestData = {
                    image_data: `data:image/png;base64,${testImageBase64}`,
                    analysis_type: 'complete_professional',
                    options: {
                        include_dominant_colors: true,
                        include_color_frequency: true,
                        include_kmeans_analysis: true,
                        include_regional_analysis: true,
                        include_histograms: true,
                        include_color_spaces: true,
                        include_characteristics: true,
                        include_ai_training_data: true,
                        include_cnn_analysis: true
                    }
                };

                log('3. Sending analysis request...', 'info');
                const startTime = Date.now();
                
                const analysisResponse = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const processingTime = Date.now() - startTime;
                log(`‚è±Ô∏è Processing time: ${processingTime}ms`, 'info');

                if (!analysisResponse.ok) {
                    log(`‚ùå HTTP Error: ${analysisResponse.status}`, 'error');
                    return;
                }

                const analysisData = await analysisResponse.json();
                log(`üìä Response size: ${JSON.stringify(analysisData).length} characters`, 'info');

                // Step 3: Test response structure
                log('4. Testing response structure...', 'info');
                
                if (analysisData.success) {
                    log('‚úÖ Analysis success: true', 'success');
                } else {
                    log(`‚ùå Analysis failed: ${analysisData.error || 'Unknown error'}`, 'error');
                    return;
                }

                // Step 4: Test dominant colors processing (the critical part)
                log('5. Testing dominant colors processing...', 'info');
                
                const dominantColors = analysisData.analysis?.dominant_colors;
                if (!dominantColors || dominantColors.length === 0) {
                    log('‚ùå No dominant colors found', 'error');
                    return;
                }

                log(`‚úÖ Found ${dominantColors.length} dominant colors`, 'success');

                // Step 5: Test RGB processing (where the error occurs)
                log('6. Testing RGB data processing...', 'info');
                
                try {
                    dominantColors.forEach((color, index) => {
                        log(`Testing color ${index + 1}: ${JSON.stringify(color)}`, 'info');
                        
                        // This is the exact code from ColorLab that was failing
                        const processedColor = processColorData(color);
                        const rgb = processedColor.rgb;
                        
                        log(`  Original RGB: ${JSON.stringify(color.rgb)}`, 'info');
                        log(`  Processed RGB: ${JSON.stringify(rgb)}`, 'info');
                        
                        // This is where the error occurred: rgb.map
                        const darkerRgb = rgb.map(c => Math.max(0, c - 30));
                        log(`  Darker RGB: ${JSON.stringify(darkerRgb)}`, 'success');
                        
                        // Create color display
                        const colorBox = document.createElement('div');
                        colorBox.className = 'color-box';
                        colorBox.style.backgroundColor = color.hex || '#808080';
                        colorBox.title = `${color.hex} - ${color.percentage}%`;
                        document.getElementById('colorDisplay').appendChild(colorBox);
                    });
                    
                    log('‚úÖ RGB processing successful - No rgb.map errors!', 'success');
                    
                } catch (error) {
                    log(`‚ùå RGB processing failed: ${error.message}`, 'error');
                    log(`Error details: ${error.stack}`, 'error');
                    return;
                }

                // Step 6: Test all analysis sections
                log('7. Testing all analysis sections...', 'info');
                const sections = ['color_frequency', 'kmeans_analysis', 'regional_analysis', 'histograms', 'color_spaces', 'characteristics', 'ai_training_data', 'cnn_analysis'];
                
                sections.forEach(section => {
                    if (analysisData.analysis[section]) {
                        log(`‚úÖ ${section}: Present`, 'success');
                    } else {
                        log(`‚ùå ${section}: Missing`, 'error');
                    }
                });

                log('üéâ ALL TESTS PASSED! ColorLab web interface should work perfectly!', 'success');
                testStatus.textContent = 'Test Completed Successfully';

            } catch (error) {
                log(`‚ùå Test failed with error: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                testStatus.textContent = 'Test Failed';
            } finally {
                testBtn.disabled = false;
            }
        }

        // Auto-run test on page load
        window.addEventListener('load', () => {
            log('üåê ColorLab Real Web Interface Test loaded', 'info');
            log('Click "Run ColorLab Test" to start testing', 'info');
        });
    </script>
</body>
</html>
